version: '3.5'

services:
  ####################### Ingestion Services #######################
  syndication:
    image: tno:syndication
    profiles:
      - all
      - service
      - data
    restart: "no"
    container_name: tno-syndication
    build:
      context: ./
      dockerfile: services/net/syndication/Dockerfile
    env_file:
      - services/net/syndication/.env
    ports:
      - ${SYNDICATION_PORT:-40020}:8081
    depends_on:
      - database
      - broker
    networks:
      - tno
    healthcheck:
      test: curl -s -f http://localhost:8081/health || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

  nlp:
    image: tno:nlp
    profiles:
      - all
      - service
      - data
    restart: "no"
    container_name: tno-nlp
    build:
      context: services/java/nlp
    env_file:
      - services/java/nlp/.env
    ports:
      - ${NLP_PORT:-40022}:8080
    volumes:
      - ./services/java/nlp/src/main/resources/models:/app/classes/models
    depends_on:
      - database
    networks:
      - tno
    healthcheck:
      test: curl -s -f http://localhost:8080/health || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

  indexing:
    image: tno:indexing
    profiles:
      - all
      - service
      - data
      - elastic
    restart: "no"
    container_name: tno-indexing
    build:
      context: services/java/indexing
    env_file:
      - services/java/indexing/.env
    ports:
      - ${INDEXING_PORT:-40023}:8080
    depends_on:
      - database
      - elastic
    networks:
      - tno
    healthcheck:
      test: curl -s -f http://localhost:8080/health || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

  clip:
    image: tno:clip
    profiles:
      - all
      - service
      - data
    restart: "no"
    container_name: tno-clip
    build:
      context: services/java/clip
    env_file:
      - services/java/clip/.env
    ports:
      - ${AUDIO_PORT:-40024}:8080
    depends_on:
      - database
      - broker
    networks:
      - tno
    volumes:
      - tno-audio-data:/data
    healthcheck:
      test: curl -s -f http://localhost:8080/health || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

  capture:
    image: tno:capture
    profiles:
      - all
      - service
      - data
    restart: "no"
    container_name: tno-capture
    build:
      context: services/java/capture
    env_file:
      - services/java/capture/.env
    ports:
      - ${AUDIO_PORT:-40025}:8080
    depends_on:
      - database
      - broker
    networks:
      - tno
    volumes:
      - tno-audio-data:/data
    healthcheck:
      test: curl -s -f http://localhost:8080/health || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  tno-audio-data:
    name: tno-audio-data
